<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æå»£æ‰è€å¸«çš„æ•¸å­¸è³‡æºç¶² | Math Lab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #2c3e50; /* æ·±è—è‰² - å­¸è¡“æ„Ÿ */
            --accent-color: #3498db;  /* äº®è—è‰² - ç§‘æŠ€æ„Ÿ */
            --dse-color: #f1c40f;     /* é‡‘è‰² - DSE é‡é» */
            --grid-color: rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Lato', 'Noto Sans TC', sans-serif;
            background-color: #f8f9fa;
            /* æ•¸å­¸æ–¹æ ¼ç´™èƒŒæ™¯æ•ˆæœ */
            background-image: 
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 20px 20px;
            min-height: 100vh;
        }

        /* é ‚éƒ¨å°èˆªæ¬„ */
        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .navbar-brand {
            color: white !important;
            font-weight: 700;
            letter-spacing: 1px;
        }

        /* å´é‚Šç¯©é¸æ¬„ */
        .sidebar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #eee;
        }
        .filter-group-title {
            font-weight: bold;
            color: var(--primary-color);
            margin-top: 15px;
            margin-bottom: 10px;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }

        /* å·¥å…·å¡ç‰‡è¨­è¨ˆ */
        .tool-card {
            background: white;
            border: none;
            border-radius: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
            position: relative;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }
        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border-color: var(--accent-color);
        }
        .card-body {
            padding: 1.5rem;
        }
        .card-title {
            font-weight: 700;
            color: var(--primary-color);
        }
        .card-meta {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 10px;
        }
        .badge-grade {
            background-color: #e3f2fd;
            color: #1565c0;
            border: 1px solid #bbdefb;
        }
        .badge-topic {
            background-color: #f3e5f5;
            color: #7b1fa2;
            border: 1px solid #e1bee7;
        }

        /* DSE å°ˆå±¬æ¨™è¨˜ */
        .dse-ribbon {
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--dse-color);
            color: #fff;
            padding: 5px 10px;
            font-size: 0.8rem;
            font-weight: bold;
            border-bottom-left-radius: 10px;
            box-shadow: -2px 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .dse-icon {
            color: #fff; 
            margin-right: 3px;
        }

        /* æ•™å¸«å°ˆç”¨é–å®šé®ç½© */
        .teacher-locked {
            filter: grayscale(1);
            opacity: 0.6;
            pointer-events: none;
        }
        
        /* æ•™å­¸è£é£¾å…ƒç´  */
        .math-deco {
            position: absolute;
            opacity: 0.1;
            z-index: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fa-solid fa-square-root-variable me-2"></i>æå»£æ‰è€å¸«_æ•¸å­¸è³‡æºç¶²
            </a>
            <div class="d-flex align-items-center">
                <button id="authBtn" class="btn btn-outline-light btn-sm" onclick="toggleAuth()">
                    <i class="fa-solid fa-user-tie me-1"></i> <span id="authText">æ•™å¸«ç™»å…¥</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        
        <div class="row mb-4 align-items-center">
            <div class="col-md-8">
                <h4 id="welcomeMsg" class="mb-1">æ­¡è¿ä¾†åˆ°æ•¸å­¸è³‡æºç¶² ğŸ‘‹</h4>
                <p class="text-muted small">é¸æ“‡ä¸‹æ–¹çš„ç¯©é¸æ¢ä»¶æ‰¾åˆ°é©åˆçš„å·¥å…·</p>
            </div>
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="fa-solid fa-magnifying-glass"></i></span>
                    <input type="text" id="searchInput" class="form-control" placeholder="æœå°‹å·¥å…·åç¨±..." onkeyup="renderTools()">
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-3 mb-4">
                <div class="sidebar">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="m-0"><i class="fa-solid fa-filter me-2"></i>ç¯©é¸</h5>
                        <button class="btn btn-sm btn-link text-decoration-none" onclick="resetFilters()">é‡ç½®</button>
                    </div>

                    <div id="studentFilters">
                        <div class="filter-group-title">å¹´ç´š</div>
                        <div class="form-check"><input class="form-check-input filter-grade" type="checkbox" value="S1" onchange="renderTools()"> <label class="form-check-label">ä¸­ä¸€ç´š</label></div>
                        <div class="form-check"><input class="form-check-input filter-grade" type="checkbox" value="S2" onchange="renderTools()"> <label class="form-check-label">ä¸­äºŒç´š</label></div>
                        <div class="form-check"><input class="form-check-input filter-grade" type="checkbox" value="S3" onchange="renderTools()"> <label class="form-check-label">ä¸­ä¸‰ç´š</label></div>
                        <div class="form-check"><input class="form-check-input filter-grade" type="checkbox" value="S4" onchange="renderTools()"> <label class="form-check-label">ä¸­å››ç´š</label></div>
                        <div class="form-check"><input class="form-check-input filter-grade" type="checkbox" value="S5" onchange="renderTools()"> <label class="form-check-label">ä¸­äº”ç´š</label></div>
                        <div class="form-check"><input class="form-check-input filter-grade" type="checkbox" value="S6" onchange="renderTools()"> <label class="form-check-label">ä¸­å…­ç´š</label></div>
                        <div class="form-check"><input class="form-check-input filter-grade" type="checkbox" value="ä¸é™å¹´ç´š" onchange="renderTools()"> <label class="form-check-label">ä¸é™</label></div>
                        

                        <div class="filter-group-title">èª²é¡Œ</div>
                        <select id="topicFilter" class="form-select form-select-sm" onchange="renderTools()">
                            <option value="">æ‰€æœ‰èª²é¡Œ</option>
                            <option value="ä»£æ•¸">ä»£æ•¸ (Algebra)</option>
                            <option value="å¹¾ä½•">å¹¾ä½• (Geometry)</option>
                            <option value="çµ±è¨ˆ">çµ±è¨ˆ (Statistics)</option>
                            <option value="æ¦‚ç‡">æ¦‚ç‡ (Probability)</option>
                            <option value="å…¶ä»–å…§å®¹">å…¶ä»–å…§å®¹ (others)</option>
                        </select>

                        <div class="filter-group-title">ç‰¹æ®Šæ¨™ç±¤</div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="dseFilter" onchange="renderTools()">
                            <label class="form-check-label text-warning fw-bold" for="dseFilter"><i class="fa-solid fa-star me-1"></i>åªé¡¯ç¤º DSE é©ç”¨</label>
                        </div>
                    </div>

                    <div id="teacherFilters" style="display: none;">
                        <div class="filter-group-title text-danger">æ•™å¸«å°ˆç”¨é¡åˆ¥</div>
                        <div class="form-check"><input class="form-check-input filter-type" type="checkbox" value="admin" onchange="renderTools()"> <label class="form-check-label">è¡Œæ”¿å·¥å…·</label></div>
                        <div class="form-check"><input class="form-check-input filter-type" type="checkbox" value="analysis" onchange="renderTools()"> <label class="form-check-label">æ•¸æ“šåˆ†æ</label></div>
                        <div class="form-check"><input class="form-check-input filter-type" type="checkbox" value="interactive" onchange="renderTools()"> <label class="form-check-label">èª²å®¤äº’å‹•</label></div>
                        <div class="form-check"><input class="form-check-input filter-type" type="checkbox" value="generator" onchange="renderTools()"> <label class="form-check-label">å·¥ä½œç´™ç”Ÿæˆ</label></div>
                    </div>
                </div>
            </div>

            <div class="col-lg-9">
                <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4" id="toolsContainer">
                    </div>
            </div>
        </div>
    </div>

  <script type="module">
        // ---------------------------------------------------------
        // 1. Firebase è¨­å®šèˆ‡åˆå§‹åŒ–
        // ---------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // â˜…â˜…â˜… è«‹å°‡ä¸‹æ–¹çš„å¤§æ‹¬è™Ÿå…§å®¹æ›¿æ›æˆæ‚¨åœ¨ Firebase Console è¤‡è£½çš„ Config â˜…â˜…â˜…
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
        apiKey: "AIzaSyBQT3fBOOFKoq13fDBVSWoi_fH9RNhXCiw",
        authDomain: "math-lab-1f07c.firebaseapp.com",
        projectId: "math-lab-1f07c",
        storageBucket: "math-lab-1f07c.firebasestorage.app",
        messagingSenderId: "52377934810",
        appId: "1:52377934810:web:22aad87d2d72d1040abee3",
        measurementId: "G-Y6ZLD904E1"
        };

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // ---------------------------------------------------------
        // 2. è³‡æ–™åº« (å·²åŒ…å« PDF/Video æ ¼å¼æ”¯æ´)
        // ---------------------------------------------------------
        const toolsData = [
            // --- å­¸ç”ŸåŠé€šç”¨å·¥å…· ---
                    {
                        id: 1,  // éš¨ä¾¿çµ¦å€‹ç·¨è™Ÿ
                        title: "æŒ‡æ•¸å®šå¾‹_æ–‡æ†‘è©¦å·ä¸€é¡Œå‹",  // å·¥å…·åç¨±
                        desc: "é‡å°HKDSEå·ä¸€æŒ‡æ•¸å®šå¾‹é¡Œå‹çš„æ¸¬é©—ã€‚", // ç°¡ä»‹
                        format: "html",
                        audience: ["student", "teacher"], // ç›®æ¨™ç”¨æˆ¶: "student", "teacher", æˆ–å…©è€…éƒ½æœ‰
                        grades: ["S3", "S4", "S5", "S6"],        // å¹´ç´š
                        topic: "ä»£æ•¸",         // èª²é¡Œ
                        isDSE: true,          // æ˜¯å¦ DSE é©ç”¨
                        updateDate: "2026-01-29", // æ—¥æœŸ
                        url: "./tools/æŒ‡æ•¸å®šå¾‹_æ–‡æ†‘è€ƒè©¦é¡Œå‹/index.html" // å°æ‡‰çš„è·¯å¾‘ (é‡è¦ï¼)
                }, 
                    {
                        id: 2,  // éš¨ä¾¿çµ¦å€‹ç·¨è™Ÿ
                        title: "å› å¼åˆ†è§£_æ–‡æ†‘è©¦å·ä¸€é¡Œå‹",  // å·¥å…·åç¨±
                        desc: "é‡å°HKDSEå·ä¸€å› å¼åˆ†è§£é¡Œå‹çš„æ¸¬é©—ã€‚", // ç°¡ä»‹
                        format: "html",
                        audience: ["student", "teacher"], // ç›®æ¨™ç”¨æˆ¶: "student", "teacher", æˆ–å…©è€…éƒ½æœ‰
                        grades: ["S3", "S4", "S5", "S6"],        // å¹´ç´š
                        topic: "ä»£æ•¸",         // èª²é¡Œ
                        isDSE: true,          // æ˜¯å¦ DSE é©ç”¨
                        updateDate: "2026-01-29", // æ—¥æœŸ
                        url: "./tools/å› å¼åˆ†è§£_æ–‡æ†‘è€ƒè©¦é¡Œå‹/index.html" // å°æ‡‰çš„è·¯å¾‘ (é‡è¦ï¼)
                },
                    {
                        id: 3,  // éš¨ä¾¿çµ¦å€‹ç·¨è™Ÿ
                        title: "ä¸»é …è®Šæ›_æ–‡æ†‘è©¦å·ä¸€é¡Œå‹",  // å·¥å…·åç¨±
                        desc: "é‡å°HKDSEå·ä¸€ä¸»é …è®Šæ›é¡Œå‹çš„æ¸¬é©—ã€‚", // ç°¡ä»‹
                        format: "html",
                        audience: ["student", "teacher"], // ç›®æ¨™ç”¨æˆ¶: "student", "teacher", æˆ–å…©è€…éƒ½æœ‰
                        grades: ["S2","S3", "S4", "S5", "S6"],        // å¹´ç´š
                        topic: "ä»£æ•¸",         // èª²é¡Œ
                        isDSE: true,          // æ˜¯å¦ DSE é©ç”¨
                        updateDate: "2026-01-29", // æ—¥æœŸ
                        url: "./tools/ä¸»é …è®Šæ›_æ–‡æ†‘è€ƒè©¦é¡Œå‹/index.html" // å°æ‡‰çš„è·¯å¾‘ (é‡è¦ï¼)
                },
                    {
                        id: 4,  // éš¨ä¾¿çµ¦å€‹ç·¨è™Ÿ
                        title: "åæ‡‰åŠ›æ¸¬è©¦_å¹³å‡æ•¸åŠä¸­ä½æ•¸è¨ˆç®—",  // å·¥å…·åç¨±
                        desc: "è¨˜éŒ„åæ‡‰ç‡ˆæ´»å‹•ä¸­çš„åæ‡‰æ™‚é–“ï¼Œä¸¦è¨ˆç®—å‡ºåæ‡‰æ™‚é–“çš„å¹³å‡æ•¸åŠä¸­ä½æ•¸ã€‚", // ç°¡ä»‹
                        format: "html",
                        audience: ["student", "teacher"], // ç›®æ¨™ç”¨æˆ¶: "student", "teacher", æˆ–å…©è€…éƒ½æœ‰
                        grades: ["S3"],        // å¹´ç´š
                        topic: "çµ±è¨ˆ",         // èª²é¡Œ
                        isDSE: false,          // æ˜¯å¦ DSE é©ç”¨
                        updateDate: "2026-01-29", // æ—¥æœŸ
                        url: "./tools/åæ‡‰åŠ›æ¸¬è©¦_å¹³å‡æ•¸åŠä¸­ä½æ•¸è¨ˆç®—/index.html" // å°æ‡‰çš„è·¯å¾‘ (é‡è¦ï¼)
                },
                    {
                        id: 5,  // éš¨ä¾¿çµ¦å€‹ç·¨è™Ÿ
                        title: "ç™¾åˆ†æ³•_ç›ˆè™§åŠæŠ˜æ‰£å•é¡Œ",  // å·¥å…·åç¨±
                        desc: "é‡å°ä¸­ä¸€ç´šç™¾åˆ†æ³•ç•¶ä¸­ç›ˆè™§åŠæŠ˜æ‰£çš„æ¸¬é©—(åˆ†ç‚ºä¸‰å€‹é›£åº¦)", // ç°¡ä»‹
                        format: "html",
                        audience: ["student", "teacher"], // ç›®æ¨™ç”¨æˆ¶: "student", "teacher", æˆ–å…©è€…éƒ½æœ‰
                        grades: ["S1"],        // å¹´ç´š
                        topic: "ä»£æ•¸",         // èª²é¡Œ
                        isDSE: false,          // æ˜¯å¦ DSE é©ç”¨
                        updateDate: "2026-01-29", // æ—¥æœŸ
                        url: "./tools/ç™¾åˆ†æ³•ï¼ˆä¸€ï¼‰_ç›ˆè™§åŠæŠ˜æ‰£å•é¡Œ/index.html" // å°æ‡‰çš„è·¯å¾‘ (é‡è¦ï¼)
                },
                    {
                        id: 6,  // éš¨ä¾¿çµ¦å€‹ç·¨è™Ÿ
                        title: "è·¯å¾‘é€£æ¥è§£è¬æŒ‘æˆ°",  // å·¥å…·åç¨±
                        desc: "è§£è¬æŒ‘æˆ° - è·¯å¾‘é€£æ¥", // ç°¡ä»‹
                        format: "html",
                        audience: ["student", "teacher"], // ç›®æ¨™ç”¨æˆ¶: "student", "teacher", æˆ–å…©è€…éƒ½æœ‰
                        grades: ["ä¸é™å¹´ç´š"],        // å¹´ç´š
                        topic: "ä»£æ•¸",         // èª²é¡Œ
                        isDSE: false,          // æ˜¯å¦ DSE é©ç”¨
                        updateDate: "2026-01-29", // æ—¥æœŸ
                        url: "./tools/è·¯å¾‘é€£æ¥è§£è¬æŒ‘æˆ°/index.html" // å°æ‡‰çš„è·¯å¾‘ (é‡è¦ï¼)
                },    
                    {
                        id: 7,  // éš¨ä¾¿çµ¦å€‹ç·¨è™Ÿ
                        title: "åæ¨™ç°¡ä»‹_é»çš„è®Šæ›",  // å·¥å…·åç¨±
                        desc: "åˆ©ç”¨å‹•ç•«é¡¯ç¤ºç›´è§’åæ¨™å¹³é¢ä¸Šçš„é»çš„è®Šæ›ï¼ŒåŒ…æ‹¬å¹³ç§», åå°„åŠæ—‹è½‰ã€‚", // ç°¡ä»‹
                        format: "html",
                        audience: ["student", "teacher"], // ç›®æ¨™ç”¨æˆ¶: "student", "teacher", æˆ–å…©è€…éƒ½æœ‰
                        grades: ["S1"],        // å¹´ç´š
                        topic: "å¹¾ä½•",         // èª²é¡Œ
                        isDSE: false,          // æ˜¯å¦ DSE é©ç”¨
                        updateDate: "2026-01-29", // æ—¥æœŸ
                        url: "./tools/ç›´è§’åæ¨™å¹³é¢ä¸Šçš„é»çš„è®Šæ›_åæ¨™ç°¡ä»‹/index.html" // å°æ‡‰çš„è·¯å¾‘ (é‡è¦ï¼)
                },   
                    {
                        id: 8,  // éš¨ä¾¿çµ¦å€‹ç·¨è™Ÿ
                        title: "æ†ç­‰å¼å±•é–‹_å¹³æ–¹å·®åŠå®Œå…¨å¹³æ–¹æ†ç­‰å¼",  // å·¥å…·åç¨±
                        desc: "é‡å°ä¸­äºŒç´šæ†ç­‰å¼ç•¶ä¸­å¹³æ–¹å·®åŠå®Œå…¨å¹³æ–¹æ†ç­‰å¼çš„æ¸¬é©—ã€‚", // ç°¡ä»‹
                        format: "html",
                        audience: ["student", "teacher"], // ç›®æ¨™ç”¨æˆ¶: "student", "teacher", æˆ–å…©è€…éƒ½æœ‰
                        grades: ["S2"],        // å¹´ç´š
                        topic: "ä»£æ•¸",         // èª²é¡Œ
                        isDSE: false,          // æ˜¯å¦ DSE é©ç”¨
                        updateDate: "2026-01-29", // æ—¥æœŸ
                        url: "./tools/å¹³æ–¹å·®åŠå®Œå…¨å¹³æ–¹æ†ç­‰å¼å±•é–‹/index.html" // å°æ‡‰çš„è·¯å¾‘ (é‡è¦ï¼)
                },  
        ];

        // ---------------------------------------------------------
        // 3. å…¨åŸŸè®Šæ•¸ (ç”¨ä¾†è¨˜éŒ„ç•¶å‰æ˜¯å¦ç‚ºæ•™å¸«)
        // ---------------------------------------------------------
        window.currentIsTeacher = false; 

        // ---------------------------------------------------------
        // 4. æ ¸å¿ƒåŠŸèƒ½ï¼šæ¸²æŸ“å·¥å…·å¡ç‰‡
        // ---------------------------------------------------------
        window.renderTools = function() {
            const container = document.getElementById('toolsContainer');
            const searchVal = document.getElementById('searchInput').value.toLowerCase();
            const checkedGrades = Array.from(document.querySelectorAll('.filter-grade:checked')).map(cb => cb.value);
            const selectedTopic = document.getElementById('topicFilter').value;
            const isDSEOnly = document.getElementById('dseFilter').checked;
            const checkedTypes = Array.from(document.querySelectorAll('.filter-type:checked')).map(cb => cb.value);

            container.innerHTML = '';

            const filtered = toolsData.filter(tool => {
                // A. æœå°‹éæ¿¾
                if (!tool.title.toLowerCase().includes(searchVal) && !tool.desc.toLowerCase().includes(searchVal)) return false;

                // B. æ¬Šé™éæ¿¾ (æ ¹æ“š Firebase ç‹€æ…‹)
                if (!window.currentIsTeacher && tool.audience.length === 1 && tool.audience[0] === 'teacher') return false;

                // C. å­¸ç”Ÿæ¨¡å¼æ¨™ç±¤éæ¿¾
                if (tool.audience.includes('student')) {
                    if (checkedGrades.length > 0) {
                        const hasMatch = tool.grades.some(g => checkedGrades.includes(g));
                        if (!hasMatch) return false;
                    }
                    if (selectedTopic && tool.topic !== selectedTopic) return false;
                    if (isDSEOnly && !tool.isDSE) return false;
                }

                // D. æ•™å¸«æ¨¡å¼é¡åˆ¥éæ¿¾
                if (window.currentIsTeacher && tool.audience.includes('teacher') && !tool.audience.includes('student')) {
                     if (checkedTypes.length > 0 && !checkedTypes.includes(tool.category)) return false;
                }

                return true;
            });

            if (filtered.length === 0) {
                container.innerHTML = `<div class="col-12 text-center text-muted py-5">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å·¥å…· <i class="fa-regular fa-face-frown"></i></div>`;
                return;
            }

            filtered.forEach(tool => {
                const isTeacherTool = tool.audience.length === 1 && tool.audience[0] === 'teacher';
                
                // æ ¼å¼åˆ¤æ–· (Icon èˆ‡æŒ‰éˆ•)
                let iconHtml = '<i class="fa-solid fa-cube text-primary me-2"></i>';
                let btnText = 'é–‹å•Ÿå·¥å…·';
                let btnClass = isTeacherTool ? 'btn-danger' : 'btn-primary';
                let targetAttr = '';

                if (tool.format === 'pdf') {
                    iconHtml = '<i class="fa-solid fa-file-pdf text-danger me-2"></i>';
                    btnText = 'ä¸‹è¼‰ / é è¦½';
                    btnClass = 'btn-outline-danger';
                    targetAttr = 'target="_blank"';
                } else if (tool.format === 'video') {
                    iconHtml = '<i class="fa-brands fa-youtube text-danger me-2"></i>';
                    btnText = 'è§€çœ‹å½±ç‰‡';
                    btnClass = 'btn-outline-dark';
                    targetAttr = 'target="_blank"';
                }

                // æ¨™ç±¤ HTML
                let tagsHtml = '';
                if (tool.grades) tool.grades.forEach(g => tagsHtml += `<span class="badge badge-grade me-1">${g}</span>`);
                if (tool.topic) tagsHtml += `<span class="badge badge-topic me-1">${tool.topic}</span>`;
                if (isTeacherTool) {
                    tagsHtml += `<span class="badge bg-danger me-1"><i class="fa-solid fa-lock me-1"></i>æ•™å¸«å°ˆç”¨</span>`;
                    tagsHtml += `<span class="badge bg-secondary me-1">${tool.category || 'ä¸€èˆ¬'}</span>`;
                }

                const dseBadge = tool.isDSE ? `<div class="dse-ribbon"><i class="fa-solid fa-star dse-icon"></i>DSE</div>` : '';

                const cardHtml = `
                    <div class="col">
                        <div class="card tool-card h-100">
                            ${dseBadge}
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${iconHtml}${tool.title}</h5>
                                <div class="mb-2">${tagsHtml}</div>
                                <p class="card-text text-secondary flex-grow-1 small">${tool.desc}</p>
                                <div class="mt-3 pt-3 border-top d-flex justify-content-between align-items-center">
                                    <small class="text-muted"><i class="fa-regular fa-calendar me-1"></i>${tool.updateDate}</small>
                                    <a href="${tool.url}" class="btn btn-sm ${btnClass}" ${targetAttr}>${btnText} <i class="fa-solid fa-arrow-right ms-1"></i></a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHtml;
            });
        };

        // ---------------------------------------------------------
        // 5. ç›£è½ Firebase ç™»å…¥ç‹€æ…‹æ”¹è®Š (è‡ªå‹•è§¸ç™¼)
        // ---------------------------------------------------------
        onAuthStateChanged(auth, (user) => {
            const btn = document.getElementById('authBtn');
            const welcomeMsg = document.getElementById('welcomeMsg');
            const teacherFilters = document.getElementById('teacherFilters');
            const studentFilters = document.getElementById('studentFilters');

            if (user) {
                // --- å·²ç™»å…¥ ---
                console.log("Teacher logged in:", user.email);
                window.currentIsTeacher = true;
                
                // UI è®Šæ›´
                btn.classList.replace('btn-outline-light', 'btn-warning');
                btn.innerHTML = `<i class="fa-solid fa-right-from-bracket me-1"></i> ç™»å‡º (${user.email.split('@')[0]})`;
                welcomeMsg.innerHTML = `æ­¡è¿å›ä¾†ï¼Œ${user.email.split('@')[0]} è€å¸« <span class="badge bg-warning text-dark">æ•™å¸«æ¨¡å¼</span>`;
                teacherFilters.style.display = 'block';
            } else {
                // --- æœªç™»å…¥ ---
                console.log("No user logged in");
                window.currentIsTeacher = false;

                // UI è®Šæ›´
                btn.classList.replace('btn-warning', 'btn-outline-light');
                btn.innerHTML = `<i class="fa-solid fa-user-tie me-1"></i> æ•™å¸«ç™»å…¥`;
                welcomeMsg.innerHTML = `æ­¡è¿ä¾†åˆ°æ•¸å­¸è³‡æºåº« ğŸ‘‹`;
                teacherFilters.style.display = 'none';
            }
            // æ¯æ¬¡ç‹€æ…‹æ”¹è®Šï¼Œéƒ½é‡æ–°æ¸²æŸ“å·¥å…·åˆ—è¡¨
            renderTools();
        });

        // ---------------------------------------------------------
        // 6. ç™»å…¥/ç™»å‡ºæŒ‰éˆ•é‚è¼¯
        // ---------------------------------------------------------
        window.toggleAuth = async function() {
            if (window.currentIsTeacher) {
                // å¦‚æœå·²ç™»å…¥ï¼Œå‰‡åŸ·è¡Œç™»å‡º
                try {
                    await signOut(auth);
                    alert("å·²æˆåŠŸç™»å‡º");
                } catch (error) {
                    console.error(error);
                    alert("ç™»å‡ºå¤±æ•—ï¼š" + error.message);
                }
            } else {
                // å¦‚æœæœªç™»å…¥ï¼Œè·³å‡ºè¦–çª—è©¢å•å¸³è™Ÿå¯†ç¢¼
                const email = prompt("è«‹è¼¸å…¥æ•™å¸« Email:");
                if (!email) return;
                const password = prompt("è«‹è¼¸å…¥å¯†ç¢¼:");
                if (!password) return;

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    // ç™»å…¥æˆåŠŸå¾Œï¼ŒonAuthStateChanged æœƒè‡ªå‹•è™•ç† UIï¼Œä¸éœ€è¦åœ¨é€™è£¡å¯«
                    alert("ç™»å…¥æˆåŠŸï¼");
                } catch (error) {
                    console.error(error);
                    // éŒ¯èª¤ä»£ç¢¼è½‰ä¸­æ–‡æç¤º (ç°¡æ˜“ç‰ˆ)
                    let msg = "ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼ã€‚";
                    if(error.code === 'auth/invalid-credential') msg = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ã€‚";
                    alert(msg);
                }
            }
        }
        
        // ---------------------------------------------------------
        // 7. å…¶ä»–è¼”åŠ©åŠŸèƒ½ (é‡ç½®ç¯©é¸)
        // ---------------------------------------------------------
        window.resetFilters = function() {
            document.querySelectorAll('input[type=checkbox]').forEach(el => el.checked = false);
            document.getElementById('searchInput').value = '';
            document.getElementById('topicFilter').value = '';
            renderTools();
        }

        // åˆæ¬¡åŸ·è¡Œ
        // æ³¨æ„ï¼šonAuthStateChanged æœƒåœ¨é é¢è¼‰å…¥å¾Œè‡ªå‹•åŸ·è¡Œä¸€æ¬¡ï¼Œæ‰€ä»¥ä¸éœ€è¦æ‰‹å‹•å‘¼å« renderTools()
    </script>
</body>
</html>