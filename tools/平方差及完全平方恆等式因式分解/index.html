<!doctype html>
<html lang="zh-TW">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>數學恆等式學習平台 - 因式分解篇</title>
  <!-- 移除 polyfill.io 以確保安全性 -->
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            }
        };
    </script>
  <style>
        /* 核心樣式設定 */
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #2e163e 50%, #3a0f60 100%); /* 紫色調區分因式分解 */
            color: #e0e6ed;
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            flex: 1;
        }

        /* 標題區域 */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .main-title {
            font-size: 2.2rem;
            font-weight: bold;
            margin: 0 0 10px 0;
            background: linear-gradient(45deg, #ba68c8, #ab47bc, #8e24aa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            font-size: 1.1rem;
            color: #d1c4e9;
            margin: 0;
        }

        /* 主選單 & 程度選單 */
        .main-menu {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 50px;
        }

        .menu-button {
            background: linear-gradient(135deg, #9c27b0, #7b1fa2);
            color: white;
            border: none;
            padding: 25px 40px;
            font-size: 1.3rem;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(156, 39, 176, 0.3);
            min-width: 280px;
            font-weight: bold;
        }

        .menu-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(156, 39, 176, 0.5);
            background: linear-gradient(135deg, #ba68c8, #8e24aa);
        }
        
        /* 程度選擇按鈕樣式 */
        .level-button-basic {
            background: linear-gradient(135deg, #66bb6a, #43a047);
        }
        .level-button-basic:hover {
            background: linear-gradient(135deg, #81c784, #4caf50);
            box-shadow: 0 15px 35px rgba(76, 175, 80, 0.5);
        }

        .level-button-advanced {
            background: linear-gradient(135deg, #ef5350, #e53935);
        }
        .level-button-advanced:hover {
            background: linear-gradient(135deg, #e57373, #f44336);
            box-shadow: 0 15px 35px rgba(244, 67, 54, 0.5);
        }

        /* 內容區域通用樣式 */
        .content-area {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .content-area.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 例題模式樣式 */
        .example-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 15px;
        }

        .example-content {
            background: rgba(0, 0, 0, 0.2);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-left: 5px solid #9c27b0;
        }

        .problem { font-size: 1.5rem; margin-bottom: 20px; color: #e1bee7; }
        .solution { font-size: 1.2rem; line-height: 1.8; color: #f3e5f5; }

        /* 測驗模式樣式 */
        .quiz-progress {
            background: rgba(255, 255, 255, 0.1);
            height: 10px;
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }

        .quiz-progress-bar {
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            height: 100%;
            transition: width 0.3s ease;
            width: 0%;
        }

        .question-text {
            font-size: 1.6rem;
            text-align: center;
            margin: 30px 0;
            color: #fff;
        }

        .answer-display {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            font-size: 1.5rem;
            color: #fff;
            margin-bottom: 20px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 1px;
        }

        /* 鍵盤樣式 */
        .keypad {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            max-width: 400px;
            margin: 0 auto;
        }

        .keypad-button {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s;
        }

        .keypad-button:hover { background: rgba(255, 255, 255, 0.2); }
        .keypad-button:active { transform: scale(0.95); }
        .keypad-button.operator { background: rgba(156, 39, 176, 0.3); border-color: rgba(156, 39, 176, 0.5); }
        .keypad-button.clear { background: rgba(244, 67, 54, 0.3); border-color: rgba(244, 67, 54, 0.5); }
        
        .variable-row {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            max-width: 450px;
            margin-left: auto;
            margin-right: auto;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .nav-button, .back-button, .submit-button {
            padding: 12px 30px;
            border-radius: 10px;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            color: white;
            transition: transform 0.2s;
        }

        .nav-button { background: #607d8b; }
        .submit-button { background: linear-gradient(135deg, #4caf50, #2e7d32); width: 200px; font-weight: bold; }
        .back-button { background: #546e7a; }
        
        .nav-button:hover, .back-button:hover, .submit-button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .nav-button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .feedback-area {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .feedback-correct {
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid #4caf50;
            color: #4caf50;
        }

        .feedback-wrong {
            background: rgba(244, 67, 54, 0.2);
            border: 2px solid #f44336;
            color: #ffcdd2;
        }

        .feedback-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; }
        .feedback-detail { font-size: 1.2rem; }

        @keyframes popIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .result-score {
            font-size: 3rem;
            text-align: center;
            color: #ba68c8;
            margin: 20px 0;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(186, 104, 200, 0.4);
        }

        .review-list { margin-top: 30px; }
        .review-item {
            background: rgba(0,0,0,0.2);
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid #ccc;
        }
        .review-item.correct { border-left-color: #4caf50; }
        .review-item.wrong { border-left-color: #f44336; }

        @media (max-width: 600px) {
            .main-title { font-size: 1.5rem; }
            .menu-button { width: 100%; min-width: auto; }
            .keypad { gap: 5px; }
            .keypad-button { padding: 12px; font-size: 1rem; }
            .action-buttons { flex-direction: column; }
            .submit-button, .back-button { width: 100%; }
        }
    </style>
 </head>
 <body>

  <div class="container">
   <header class="header">
    <h1 class="main-title">數學恆等式學習平台</h1>
    <p class="subtitle">中二級 - 恆等式因式分解</p>
   </header>

   <!-- 主選單：選擇恆等式 -->
   <div id="mainMenu" class="content-area active" style="text-align: center;">
    <h2 style="color: #fff; margin-bottom: 30px;">請選擇恆等式</h2>
    <div class="main-menu">
        <button class="menu-button" onclick="showLevelMenu('difference')">
            平方差恆等式<br>
            <span style="font-size: 0.9rem; font-weight: normal; opacity: 0.8;">$a^2-b^2 = (a+b)(a-b)$</span>
        </button> 
        <button class="menu-button" onclick="showLevelMenu('perfectSquare')" style="background: linear-gradient(135deg, #ff9800, #f57c00);">
            完全平方恆等式<br>
            <span style="font-size: 0.9rem; font-weight: normal; opacity: 0.8;">$a^2 \pm 2ab + b^2 = (a\pm b)^2$</span>
        </button>
    </div>
   </div>

   <!-- 程度選擇選單 -->
   <div id="levelMenu" class="content-area" style="text-align: center;">
    <h2 id="levelMenuTitle" style="color: #fff; margin-bottom: 30px;">請選擇挑戰程度</h2>
    <div class="main-menu">
        <button class="menu-button level-button-basic" onclick="startLevel('basic')">
            初階挑戰 (Basic)<br>
            <span style="font-size: 0.9rem; font-weight: normal; opacity: 0.8;">基礎運算 (5題)</span>
        </button> 
        <button class="menu-button level-button-advanced" onclick="startLevel('advanced')">
            高階挑戰 (Advanced)<br>
            <span style="font-size: 0.9rem; font-weight: normal; opacity: 0.8;">進階運算 (5題)</span>
        </button>
    </div>
    <div style="text-align: center; margin-top: 30px;">
        <button class="back-button" onclick="showMainMenu()">返回主選單</button>
    </div>
   </div>

   <div id="exampleArea" class="content-area">
    <div class="example-header">
     <h2 id="exampleTitle" style="margin:0; color:#ba68c8;">例題學習</h2>
     <div style="background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 20px;">
        例題 <span id="currentExampleNum">1</span> / <span id="totalExampleNum">5</span>
     </div>
    </div>

    <div class="example-content">
     <div class="problem" id="exampleProblem">題目載入中...</div>
     <hr style="border: 0; border-top: 1px dashed rgba(255,255,255,0.2); margin: 20px 0;">
     <div class="solution" id="exampleSolution">解答載入中...</div>
    </div>

    <div class="action-buttons">
        <button class="nav-button" id="prevExBtn" onclick="changeExample(-1)">上一題</button>
        <button class="submit-button" onclick="switchToQuiz()">進入測驗</button>
        <button class="nav-button" id="nextExBtn" onclick="changeExample(1)">下一題</button>
    </div>
    <div style="text-align: center; margin-top: 20px;">
        <button class="back-button" onclick="showLevelMenu(currentMode)">返回程度選單</button>
    </div>
   </div>

   <div id="quizArea" class="content-area">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2 id="quizTitle" style="margin:0; color:#ff9800;">測驗中</h2>
        <span>題目 <span id="currentQuestionNum">1</span> / 5</span>
    </div>

    <div class="quiz-progress">
       <div class="quiz-progress-bar" id="progressBar"></div>
    </div>

    <div class="question-text" id="quizQuestion">題目載入中...</div>

    <div class="answer-display" id="answerDisplay">
        點擊下方鍵盤輸入答案
    </div>

    <div id="feedbackArea" class="feedback-area">
        <div class="feedback-title" id="feedbackTitle"></div>
        <div class="feedback-detail" id="feedbackDetail"></div>
    </div>

    <div id="inputArea">
        <div class="keypad">
            <button class="keypad-button" onclick="inputChar('7')">7</button>
            <button class="keypad-button" onclick="inputChar('8')">8</button>
            <button class="keypad-button" onclick="inputChar('9')">9</button>
            <button class="keypad-button operator" onclick="inputChar('+')">+</button>
            
            <button class="keypad-button" onclick="inputChar('4')">4</button>
            <button class="keypad-button" onclick="inputChar('5')">5</button>
            <button class="keypad-button" onclick="inputChar('6')">6</button>
            <button class="keypad-button operator" onclick="inputChar('-')">-</button>
            
            <button class="keypad-button" onclick="inputChar('1')">1</button>
            <button class="keypad-button" onclick="inputChar('2')">2</button>
            <button class="keypad-button" onclick="inputChar('3')">3</button>
            <button class="keypad-button operator" onclick="inputChar('^2')">$x^2$</button>
            
            <button class="keypad-button" onclick="inputChar('0')">0</button>
            <button class="keypad-button operator" onclick="inputChar('(')">(</button>
            <button class="keypad-button operator" onclick="inputChar(')')">)</button>
            <button class="keypad-button clear" onclick="clearInput()">清除</button>
        </div>
        <div class="variable-row">
            <button class="keypad-button operator" onclick="inputChar('a')">$a$</button>
            <button class="keypad-button operator" onclick="inputChar('b')">$b$</button>
            <button class="keypad-button operator" onclick="inputChar('c')">$c$</button>
            <button class="keypad-button operator" onclick="inputChar('d')">$d$</button>
            <button class="keypad-button operator" onclick="inputChar('h')">$h$</button>
            <button class="keypad-button operator" onclick="inputChar('k')">$k$</button>
            <button class="keypad-button operator" onclick="inputChar('m')">$m$</button>
            <button class="keypad-button operator" onclick="inputChar('n')">$n$</button>
            <button class="keypad-button operator" onclick="inputChar('x')">$x$</button>
            <button class="keypad-button operator" onclick="inputChar('y')">$y$</button>
        </div>
    </div>

    <div class="action-buttons">
        <button id="quizActionBtn" class="submit-button" onclick="handleQuizAction()">提交答案</button>
    </div>
    <div style="text-align: center; margin-top: 15px;">
        <button class="back-button" onclick="confirmQuitQuiz()">退出測驗</button>
    </div>
   </div>

   <div id="resultArea" class="content-area">
    <h2 style="text-align: center; color: #fff;">測驗完成</h2>
    
    <div class="result-score" id="finalScore">
        80分
    </div>
    <p style="text-align: center; font-size: 1.2rem; color: #b0bec5;" id="scoreComment">做得不錯！</p>

    <div class="action-buttons">
        <button class="submit-button" onclick="restartQuiz()">再試一次</button>
        <button class="back-button" onclick="showLevelMenu(currentMode)">返回程度選單</button>
    </div>

    <h3 style="margin-top: 40px; color: #ba68c8;">答題檢討</h3>
    <div class="review-list" id="reviewList">
        </div>
   </div>

  </div>

  <script>
    // --- 資料結構 ---
    // 因式分解題庫 (題目為展開形式，答案為因式形式)
    const examplesData = {
        difference: [
            // Basic Examples
            { q: "$a^2 - 9$", a: "$$ \\begin{align*} a^2 - 9 &= a^2 - 3^2 \\\\ &= (a+3)(a-3) \\end{align*} $$" },
            { q: "$49 - b^2$", a: "$$ \\begin{align*} 49 - b^2 &= 7^2 - b^2 \\\\ &= (7+b)(7-b) \\end{align*} $$" },
            { q: "$4a^2 - 9$", a: "$$ \\begin{align*} 4a^2 - 9 &= (2a)^2 - 3^2 \\\\ &= (2a+3)(2a-3) \\end{align*} $$" },
            { q: "$16 - 25c^2$", a: "$$ \\begin{align*} 16 - 25c^2 &= 4^2 - (5c)^2 \\\\ &= (4+5c)(4-5c) \\end{align*} $$" },
            { q: "$9x^2 - 16y^2$", a: "$$ \\begin{align*} 9x^2 - 16y^2 &= (3x)^2 - (4y)^2 \\\\ &= (3x+4y)(3x-4y) \\end{align*} $$" },
            // Advanced Examples
            { q: "$m^2 - 9$", a: "$$ \\begin{align*} m^2 - 9 &= (-m)^2 - 3^2 \\\\ &= (-m+3)(-m-3) \\quad \\text{或} \\quad (m+3)(m-3) \\end{align*} $$" },
            { q: "$36x^2 - y^2$", a: "$$ \\begin{align*} 36x^2 - y^2 &= (-6x)^2 - y^2 \\\\ &= (-6x+y)(-6x-y) \\end{align*} $$" },
            { q: "$81b^2 - a^2$", a: "$$ \\begin{align*} 81b^2 - a^2 &= (9b)^2 - a^2 \\\\ &= (9b+a)(9b-a) \\end{align*} $$" },
            { q: "$100a^2 - 196$", a: "先提取公因式 4： $$ \\begin{align*} 100a^2 - 196 &= 4(25a^2 - 49) \\\\ &= 4[(5a)^2 - 7^2] \\\\ &= 4(5a+7)(5a-7) \\end{align*} $$" },
            { q: "$-320m^2 + 45n^2$", a: "先提取公因式 -5： $$ \\begin{align*} -320m^2 + 45n^2 &= -5(64m^2 - 9n^2) \\\\ &= -5[(8m)^2 - (3n)^2] \\\\ &= -5(8m+3n)(8m-3n) \\end{align*} $$" }
        ],
        perfectSquare: [
            // Basic Examples
            { q: "$h^2 + 6h + 9$", a: "$$ \\begin{align*} h^2 + 6h + 9 &= h^2 + 2(h)(3) + 3^2 \\\\ &= (h+3)^2 \\end{align*} $$" },
            { q: "$k^2 - 6k + 9$", a: "$$ \\begin{align*} k^2 - 6k + 9 &= k^2 - 2(k)(3) + 3^2 \\\\ &= (k-3)^2 \\end{align*} $$" },
            { q: "$4a^2 + 20a + 25$", a: "$$ \\begin{align*} 4a^2 + 20a + 25 &= (2a)^2 + 2(2a)(5) + 5^2 \\\\ &= (2a+5)^2 \\end{align*} $$" },
            { q: "$9n^2 - 42n + 49$", a: "$$ \\begin{align*} 9n^2 - 42n + 49 &= (3n)^2 - 2(3n)(7) + 7^2 \\\\ &= (3n-7)^2 \\end{align*} $$" },
            { q: "$16 + 40d + 25d^2$", a: "$$ \\begin{align*} 16 + 40d + 25d^2 &= 4^2 + 2(4)(5d) + (5d)^2 \\\\ &= (4+5d)^2 \\end{align*} $$" },
            // Advanced Examples
            { q: "$81 + 36a + 4a^2$", a: "$$ \\begin{align*} 81 + 36a + 4a^2 &= 9^2 + 2(9)(2a) + (2a)^2 \\\\ &= (9+2a)^2 \\end{align*} $$" },
            { q: "$9a^2 + 12ab + 4b^2$", a: "$$ \\begin{align*} 9a^2 + 12ab + 4b^2 &= (3a)^2 + 2(3a)(2b) + (2b)^2 \\\\ &= (3a+2b)^2 \\end{align*} $$" },
            { q: "$4x^2 - 12xy + 9y^2$", a: "$$ \\begin{align*} 4x^2 - 12xy + 9y^2 &= (2x)^2 - 2(2x)(3y) + (3y)^2 \\\\ &= (2x-3y)^2 \\end{align*} $$" },
            { q: "$-49 + 84b - 36b^2$", a: "提取負號： $$ \\begin{align*} -49 + 84b - 36b^2 &= -(49 - 84b + 36b^2) \\\\ &= -[7^2 - 2(7)(6b) + (6b)^2] \\\\ &= -(7-6b)^2 \\end{align*} $$" },
            { q: "$48m^2 + 24mn + 3n^2$", a: "提取公因式 3： $$ \\begin{align*} 48m^2 + 24mn + 3n^2 &= 3(16m^2 + 8mn + n^2) \\\\ &= 3[(4m)^2 + 2(4m)(n) + n^2] \\\\ &= 3(4m+n)^2 \\end{align*} $$" }
        ]
    };

    // --- 全局變數 ---
    let currentMode = ''; 
    let currentLevel = ''; 
    let currentExampleIndex = 0;
    
    // 測驗變數
    let quizQuestions = [];
    let currentQuestionIndex = 0;
    let userScore = 0;
    let currentInput = '';
    let quizState = 'answering'; 
    let userHistory = []; 

    // Helper: GCD Function
    function gcd(a, b) {
        return b === 0 ? a : gcd(b, a % b);
    }

    // --- 核心邏輯：題目生成器 (產生因式分解題目) ---
    function generateQuizQuestions(type, level) {
        const questions = [];
        const variables = ['a', 'b', 'c', 'd', 'h', 'k', 'm', 'n', 'x', 'y'];
        
        let patterns = [];

        if (type === 'difference') {
            patterns = [
                // 1. Basic: a^2 - n^2 -> (a+n)(a-n)
                () => {
                    const v = variables[Math.floor(Math.random() * variables.length)];
                    const n = Math.floor(Math.random() * 9) + 2;
                    return { q: `${v}^2-${n*n}`, a: `(${v}+${n})(${v}-${n})` };
                },
                // 2. Basic: n^2 - a^2 -> (n+a)(n-a)
                () => {
                    const v = variables[Math.floor(Math.random() * variables.length)];
                    const n = Math.floor(Math.random() * 9) + 2;
                    return { q: `${n*n}-${v}^2`, a: `(${n}+${v})(${n}-${v})` };
                },
                // 3. Basic: c^2v^2 - n^2 -> (cv+n)(cv-n) [Ensure c, n coprime]
                () => {
                    const v = variables[Math.floor(Math.random() * variables.length)];
                    let c, n;
                    do {
                        c = Math.floor(Math.random() * 8) + 2;
                        n = Math.floor(Math.random() * 9) + 2;
                    } while (c === n || gcd(c, n) !== 1);
                    return { q: `${c*c}${v}^2-${n*n}`, a: `(${c}${v}+${n})(${c}${v}-${n})` };
                },
                // 4. Basic: n^2 - c^2v^2 -> (n+cv)(n-cv) [Ensure c, n coprime]
                () => {
                    const v = variables[Math.floor(Math.random() * variables.length)];
                    let c, n;
                    do {
                        c = Math.floor(Math.random() * 8) + 2;
                        n = Math.floor(Math.random() * 9) + 2;
                    } while (c === n || gcd(c, n) !== 1);
                    return { q: `${n*n}-${c*c}${v}^2`, a: `(${n}+${c}${v})(${n}-${c}${v})` };
                },
                // 5. Basic: c1^2v1^2 - c2^2v2^2 -> (c1v1+c2v2)(c1v1-c2v2) [Ensure c1, c2 coprime]
                () => {
                    const v1 = variables[Math.floor(Math.random() * variables.length)];
                    let v2 = variables[Math.floor(Math.random() * variables.length)];
                    while (v1 === v2) v2 = variables[Math.floor(Math.random() * variables.length)];
                    let c1, c2;
                    do {
                        c1 = Math.floor(Math.random() * 8) + 2;
                        c2 = Math.floor(Math.random() * 8) + 2;
                    } while (c1 === c2 || gcd(c1, c2) !== 1);
                    return { q: `${c1*c1}${v1}^2-${c2*c2}${v2}^2`, a: `(${c1}${v1}+${c2}${v2})(${c1}${v1}-${c2}${v2})` };
                },
                // 6. Advanced: v1^2 - v2^2
                () => {
                    const v1 = variables[Math.floor(Math.random() * variables.length)];
                    let v2 = variables[Math.floor(Math.random() * variables.length)];
                    while (v1 === v2) v2 = variables[Math.floor(Math.random() * variables.length)];
                    return { q: `${v1}^2-${v2}^2`, a: `(${v1}+${v2})(${v1}-${v2})` };
                },
                // 7. Advanced: 涉及公因數 k(a^2 - b^2)
                () => {
                    const v = variables[Math.floor(Math.random() * variables.length)];
                    const coeff = Math.floor(Math.random() * 4) + 2; 
                    const n = Math.floor(Math.random() * 5) + 2;
                    return { q: `${coeff}${v}^2-${coeff*n*n}`, a: `${coeff}(${v}+${n})(${v}-${n})` };
                },
                // 8. Advanced: 複雜係數 (cv1)^2 - v2^2
                () => {
                    const v1 = variables[Math.floor(Math.random() * variables.length)];
                    let v2 = variables[Math.floor(Math.random() * variables.length)];
                    while (v1 === v2) v2 = variables[Math.floor(Math.random() * variables.length)];
                    const c = Math.floor(Math.random() * 8) + 2;
                    return { q: `${c*c}${v1}^2-${v2}^2`, a: `(${c}${v1}+${v2})(${c}${v1}-${v2})` };
                },
                // 9. Advanced: 公因數 + 係數 k(c^2v^2 - n^2) [Ensure c, n coprime]
                () => {
                    const v = variables[Math.floor(Math.random() * variables.length)];
                    const k = Math.floor(Math.random() * 3) + 2;
                    let c, n;
                    do {
                        c = Math.floor(Math.random() * 3) + 2;
                        n = Math.floor(Math.random() * 4) + 2;
                    } while (gcd(c, n) !== 1);
                    return { q: `${k*c*c}${v}^2-${k*n*n}`, a: `${k}(${c}${v}+${n})(${c}${v}-${n})` };
                },
                // 10. Advanced: 負號提取 -v1^2 + v2^2
                () => {
                     const v1 = variables[Math.floor(Math.random() * variables.length)];
                     let v2 = variables[Math.floor(Math.random() * variables.length)];
                     while (v1 === v2) v2 = variables[Math.floor(Math.random() * variables.length)];
                     return { q: `-${v1}^2+${v2}^2`, a: `(${v2}+${v1})(${v2}-${v1})` };
                }
            ];
        } else {
            // Perfect Square Factorization
            patterns = [
                // 1. Basic: v^2 + 2nv + n^2 -> (v+n)^2
                () => {
                    const v = variables[Math.floor(Math.random() * variables.length)];
                    const n = Math.floor(Math.random() * 9) + 2;
                    return { q: `${v}^2+${2*n}${v}+${n*n}`, a: `(${v}+${n})^2` };
                },
                // 2. Basic: v^2 - 2nv + n^2 -> (v-n)^2
                () => {
                    const v = variables[Math.floor(Math.random() * variables.length)];
                    const n = Math.floor(Math.random() * 9) + 2;
                    return { q: `${v}^2-${2*n}${v}+${n*n}`, a: `(${v}-${n})^2` };
                },
                // 3. Basic: c^2v^2 + 2cnv + n^2 -> (cv+n)^2 [Ensure c, n coprime]
                () => {
                    const v = variables[Math.floor(Math.random() * variables.length)];
                    let c, n;
                    do {
                        c = Math.floor(Math.random() * 5) + 2;
                        n = Math.floor(Math.random() * 5) + 2;
                    } while (gcd(c, n) !== 1);
                    return { q: `${c*c}${v}^2+${2*c*n}${v}+${n*n}`, a: `(${c}${v}+${n})^2` };
                },
                // 4. Basic: c^2v^2 - 2cnv + n^2 -> (cv-n)^2 [Ensure c, n coprime]
                () => {
                    const v = variables[Math.floor(Math.random() * variables.length)];
                    let c, n;
                    do {
                        c = Math.floor(Math.random() * 5) + 2;
                        n = Math.floor(Math.random() * 5) + 2;
                    } while (gcd(c, n) !== 1);
                    return { q: `${c*c}${v}^2-${2*c*n}${v}+${n*n}`, a: `(${c}${v}-${n})^2` };
                },
                // 5. Basic: n^2 + 2cnv + c^2v^2 -> (n+cv)^2 [Ensure c, n coprime]
                () => {
                    const v = variables[Math.floor(Math.random() * variables.length)];
                    let c, n;
                    do {
                        c = Math.floor(Math.random() * 5) + 2;
                        n = Math.floor(Math.random() * 5) + 2;
                    } while (gcd(c, n) !== 1);
                    return { q: `${n*n}+${2*c*n}${v}+${c*c}${v}^2`, a: `(${n}+${c}${v})^2` };
                },
                // 6. Advanced: c1^2v1^2 + 2c1c2v1v2 + c2^2v2^2 -> (c1v1+c2v2)^2 [Ensure c1, c2 coprime]
                () => {
                    const v1 = variables[Math.floor(Math.random() * variables.length)];
                    let v2 = variables[Math.floor(Math.random() * variables.length)];
                    while (v1 === v2) v2 = variables[Math.floor(Math.random() * variables.length)];
                    let c1, c2;
                    do {
                        c1 = Math.floor(Math.random() * 4) + 2;
                        c2 = Math.floor(Math.random() * 4) + 2;
                    } while (c1 === c2 || gcd(c1, c2) !== 1);
                    return { q: `${c1*c1}${v1}^2+${2*c1*c2}${v1}${v2}+${c2*c2}${v2}^2`, a: `(${c1}${v1}+${c2}${v2})^2` };
                },
                // 7. Advanced: 減法版 (c1v1-c2v2)^2 [Ensure c1, c2 coprime]
                () => {
                    const v1 = variables[Math.floor(Math.random() * variables.length)];
                    let v2 = variables[Math.floor(Math.random() * variables.length)];
                    while (v1 === v2) v2 = variables[Math.floor(Math.random() * variables.length)];
                    let c1, c2;
                    do {
                        c1 = Math.floor(Math.random() * 4) + 2;
                        c2 = Math.floor(Math.random() * 4) + 2;
                    } while (c1 === c2 || gcd(c1, c2) !== 1);
                    return { q: `${c1*c1}${v1}^2-${2*c1*c2}${v1}${v2}+${c2*c2}${v2}^2`, a: `(${c1}${v1}-${c2}${v2})^2` };
                },
                // 8. Advanced: 提取公因數 k(a^2 + 2ab + b^2)
                () => {
                    const v = variables[Math.floor(Math.random() * variables.length)];
                    const k = Math.floor(Math.random() * 3) + 2;
                    const n = Math.floor(Math.random() * 4) + 2;
                    return { q: `${k}${v}^2+${k*2*n}${v}+${k*n*n}`, a: `${k}(${v}+${n})^2` };
                },
                // 9. Advanced: 提取負號 -a^2 - 2ab - b^2 -> -(a+b)^2
                () => {
                    const v = variables[Math.floor(Math.random() * variables.length)];
                    const n = Math.floor(Math.random() * 9) + 2;
                    return { q: `-${v}^2-${2*n}${v}-${n*n}`, a: `-(${v}+${n})^2` };
                },
                // 10. Advanced: 複雜係數公因數 k(c^2v^2 - 2cnv + n^2) [Ensure c, n coprime]
                () => {
                    const v = variables[Math.floor(Math.random() * variables.length)];
                    const k = Math.floor(Math.random() * 3) + 2;
                    let c, n;
                    do {
                        c = Math.floor(Math.random() * 3) + 2;
                        n = Math.floor(Math.random() * 3) + 2;
                    } while (gcd(c, n) !== 1);
                    return { q: `${k*c*c}${v}^2-${k*2*c*n}${v}+${k*n*n}`, a: `${k}(${c}${v}-${n})^2` };
                }
            ];
        }

        const start = level === 'basic' ? 0 : 5;
        const end = level === 'basic' ? 5 : 10;
        
        for (let i = start; i < end; i++) {
            questions.push(patterns[i]());
        }
        
        return questions;
    }

    // --- 核心邏輯：因式分解答案比對系統 ---
    
    // 標準化字符串：移除空格，處理符號
    function cleanString(str) {
        return str.replace(/\s+/g, '').replace(/\+-/g, '-').replace(/--/g, '+');
    }

    // 檢查因式分解答案是否等價
    function checkAnswer(userInput, correctAnswer) {
        const user = cleanString(userInput);
        const correct = cleanString(correctAnswer);

        if (user === correct) return true;

        // 處理平方差等價情況: (A+B)(A-B) == (A-B)(A+B)
        // 簡單邏輯：如果答案是 (part1)(part2) 的形式，嘗試交換順序比對
        if (correct.match(/^\(.+\)\(.+\)$/)) {
            // 嘗試解析出兩個括號的內容。
            // 這裡假設括號沒有嵌套太深，簡單分割
            // 尋找中間的 ) (
            const splitIndex = correct.indexOf(')(');
            if (splitIndex !== -1) {
                const part1 = correct.substring(0, splitIndex + 1); // (A+B)
                const part2 = correct.substring(splitIndex + 1);     // (A-B)
                const swapped = part2 + part1;
                if (user === swapped) return true;
            }
        }

        // 處理完全平方等價情況 (較少見，但例如 (-a-b)^2 == (a+b)^2)
        // 在此系統中主要檢查用戶是否寫反了如 (b+a)^2 vs (a+b)^2
        // 但因為我們產生器通常固定順序，這部分主要依賴 normalizeExpression (如果有引用的話)
        // 由於我們移除了複雜的 normalizeExpression，這裡採用簡單策略：
        // 如果題目是完全平方，接受 (A+B)^2 和 (B+A)^2 (針對加法)
        if (correct.endsWith('^2')) {
            const content = correct.substring(1, correct.length - 3); // 去掉 (^2
            if (content.includes('+')) {
                const parts = content.split('+');
                if (parts.length === 2) {
                    const swappedInner = `(${parts[1]}+${parts[0]})^2`;
                    if (user === swappedInner) return true;
                }
            }
        }
        
        // 處理負號提取的等價: -(A-B)^2 == -(B-A)^2
        if (correct.startsWith('-(') && correct.endsWith(')^2')) {
             const content = correct.substring(2, correct.length - 3); // A-B
             if (content.includes('-')) {
                 const parts = content.split('-');
                 if (parts.length === 2) {
                     // -(B-A)^2 (注意這裡只處理簡單變數減法，未處理係數複雜情況)
                     // 為了避免誤判，這裡只針對簡單情況做檢查
                 }
             }
        }

        return false;
    }

    // --- 頁面邏輯 (保持與原版一致) ---
    function showMainMenu() {
        hideAllSections();
        document.getElementById('mainMenu').classList.add('active');
    }

    function hideAllSections() {
        document.querySelectorAll('.content-area').forEach(el => el.classList.remove('active'));
    }

    function showLevelMenu(mode) {
        currentMode = mode;
        hideAllSections();
        document.getElementById('levelMenu').classList.add('active');
        
        const modeName = mode === 'difference' ? '平方差恆等式' : '完全平方恆等式';
        document.getElementById('levelMenuTitle').innerHTML = `請選擇挑戰程度<br><span style="font-size:1.2rem; color:#d1c4e9">${modeName}</span>`;
    }

    function startLevel(level) {
        currentLevel = level;
        currentExampleIndex = 0;
        
        hideAllSections();
        document.getElementById('exampleArea').classList.add('active');
        
        const modeName = currentMode === 'difference' ? '平方差恆等式' : '完全平方恆等式';
        const levelName = currentLevel === 'basic' ? '初階' : '高階';
        document.getElementById('exampleTitle').textContent = `${modeName} - ${levelName}例題`;
        
        renderExample();
    }

    function getExampleList() {
        const fullList = examplesData[currentMode];
        if (currentLevel === 'basic') return fullList.slice(0, 5);
        return fullList.slice(5, 10);
    }

    function renderExample() {
        const list = getExampleList();
        const ex = list[currentExampleIndex];
        
        document.getElementById('currentExampleNum').textContent = currentExampleIndex + 1;
        document.getElementById('totalExampleNum').textContent = list.length;
        
        const probEl = document.getElementById('exampleProblem');
        const solEl = document.getElementById('exampleSolution');
        
        probEl.innerHTML = `因式分解 ${ex.q}`;
        solEl.innerHTML = `步驟：<br>${ex.a}`;
        
        document.getElementById('prevExBtn').disabled = currentExampleIndex === 0;
        document.getElementById('nextExBtn').disabled = currentExampleIndex === list.length - 1;

        if (window.MathJax) MathJax.typesetPromise([probEl, solEl]);
    }

    function changeExample(delta) {
        const list = getExampleList();
        const newIndex = currentExampleIndex + delta;
        if (newIndex >= 0 && newIndex < list.length) {
            currentExampleIndex = newIndex;
            renderExample();
        }
    }

    function switchToQuiz() {
        quizQuestions = generateQuizQuestions(currentMode, currentLevel);
        currentQuestionIndex = 0;
        userScore = 0;
        userHistory = [];
        
        hideAllSections();
        document.getElementById('quizArea').classList.add('active');
        
        const modeName = currentMode === 'difference' ? '平方差' : '完全平方';
        const levelName = currentLevel === 'basic' ? '初階' : '高階';
        document.getElementById('quizTitle').textContent = `${modeName}${levelName}測驗`;
        
        loadQuestion();
    }

    function loadQuestion() {
        const q = quizQuestions[currentQuestionIndex];
        
        quizState = 'answering';
        currentInput = '';
        updateInputDisplay('點擊下方鍵盤輸入答案');
        
        document.getElementById('feedbackArea').style.display = 'none';
        document.getElementById('inputArea').style.pointerEvents = 'auto';
        document.getElementById('inputArea').style.opacity = '1';
        
        const actionBtn = document.getElementById('quizActionBtn');
        actionBtn.textContent = '提交答案';
        actionBtn.className = 'submit-button';
        actionBtn.style.background = '';

        document.getElementById('currentQuestionNum').textContent = currentQuestionIndex + 1;
        document.getElementById('progressBar').style.width = `${((currentQuestionIndex)/5)*100}%`;
        
        const qEl = document.getElementById('quizQuestion');
        qEl.innerHTML = `因式分解 $${q.q}$`;
        if (window.MathJax) MathJax.typesetPromise([qEl]);
    }

    function inputChar(char) {
        if (quizState !== 'answering') return;
        currentInput += char;
        updateInputDisplay(`$${currentInput}$`);
    }

    function clearInput() {
        if (quizState !== 'answering') return;
        currentInput = '';
        updateInputDisplay('點擊下方鍵盤輸入答案');
    }

    function updateInputDisplay(content) {
        const el = document.getElementById('answerDisplay');
        el.innerHTML = content;
        if (content.includes('$') && window.MathJax) {
            MathJax.typesetPromise([el]);
        }
    }

    function handleQuizAction() {
        if (quizState === 'answering') {
            submitAnswer();
        } else {
            nextQuestion();
        }
    }

    function submitAnswer() {
        if (!currentInput.trim()) return;

        const correctAnswer = quizQuestions[currentQuestionIndex].a;
        const isCorrect = checkAnswer(currentInput, correctAnswer);
        
        userHistory.push({
            q: quizQuestions[currentQuestionIndex].q,
            userA: currentInput,
            correctA: correctAnswer,
            isCorrect: isCorrect
        });

        if (isCorrect) userScore++;

        showFeedback(isCorrect, correctAnswer);

        quizState = 'reviewing';
        const actionBtn = document.getElementById('quizActionBtn');
        actionBtn.textContent = (currentQuestionIndex < 4) ? '下一題' : '查看結果';
        actionBtn.style.background = isCorrect ? '#4caf50' : '#607d8b';
        
        document.getElementById('inputArea').style.pointerEvents = 'none';
        document.getElementById('inputArea').style.opacity = '0.5';
    }

    function showFeedback(isCorrect, correctAnswer) {
        const fbArea = document.getElementById('feedbackArea');
        const fbTitle = document.getElementById('feedbackTitle');
        const fbDetail = document.getElementById('feedbackDetail');

        fbArea.style.display = 'block';
        fbArea.className = 'feedback-area ' + (isCorrect ? 'feedback-correct' : 'feedback-wrong');
        
        if (isCorrect) {
            fbTitle.innerHTML = '✓ 回答正確！';
            fbDetail.innerHTML = '';
        } else {
            fbTitle.innerHTML = '✗ 回答錯誤';
            fbDetail.innerHTML = `正確答案是：$${correctAnswer}$`;
            if (window.MathJax) MathJax.typesetPromise([fbDetail]);
        }
    }

    function nextQuestion() {
        currentQuestionIndex++;
        if (currentQuestionIndex < 5) {
            loadQuestion();
        } else {
            showResultPage();
        }
    }

    function confirmQuitQuiz() {
        if (confirm("確定要退出測驗嗎？目前的進度將會遺失。")) {
            showLevelMenu(currentMode);
        }
    }

    function showResultPage() {
        hideAllSections();
        document.getElementById('resultArea').classList.add('active');
        
        const finalScore = userScore * 20;
        document.getElementById('finalScore').textContent = `${finalScore}分`;
        
        let comment = '';
        if (finalScore === 100) comment = "太完美了！代數高手就是你！";
        else if (finalScore >= 80) comment = "非常優秀！因式分解掌握得很好。";
        else if (finalScore >= 60) comment = "及格了，要注意正負號和括號喔！";
        else comment = "再接再厲，多練習例題會更有幫助喔！";
        document.getElementById('scoreComment').textContent = comment;

        const listEl = document.getElementById('reviewList');
        listEl.innerHTML = '';
        
        userHistory.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = `review-item ${item.isCorrect ? 'correct' : 'wrong'}`;
            div.innerHTML = `
                <div style="margin-bottom:5px;"><strong>第 ${idx+1} 題：</strong> 因式分解 $${item.q}$</div>
                <div style="display:flex; flex-wrap:wrap; gap:15px; font-size: 0.95rem;">
                    <span style="color: ${item.isCorrect ? '#4caf50' : '#f44336'}">你的答案：$${item.userA}$</span>
                    ${!item.isCorrect ? `<span>正確答案：$${item.correctA}$</span>` : ''}
                </div>
            `;
            listEl.appendChild(div);
        });

        if (window.MathJax) MathJax.typesetPromise([listEl]);
    }

    function restartQuiz() {
        switchToQuiz();
    }

    document.addEventListener('DOMContentLoaded', () => {
        showMainMenu();
    });

  </script>
 </body>
</html>